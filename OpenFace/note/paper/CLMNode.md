# Feature Detection and Tracking with Constrained Local Models (CLM)
# 特征检测与跟踪的约束局部模型

## 形状与纹理

### 人脸形状提取

假设我们有一个包含多张人脸图像的数据集，每张图像都标记了6个关键特征点：左眼角、右眼角、鼻尖、左嘴角、右嘴角和下巴中心。

形状表示：

对于每张人脸图像，我们可以将这6个特征点的x和y坐标连接成一个向量。例如，对于第一张人脸，其形状向量可以表示为：
x1 = [左眼角x, 左眼角y, 右眼角x, 右眼角y, 鼻尖x, 鼻尖y, 左嘴角x, 左嘴角y, 右嘴角x, 右嘴角y, 下巴中心x, 下巴中心y]

形状归一化：

- 平移归一化：
计算所有特征点坐标的平均值，然后将每个特征点的坐标减去相应的平均值，使形状的中心位于原点。
- 尺度归一化：
计算所有特征点到原点的平均距离，然后将每个特征点的坐标除以这个平均距离，使形状的大小标准化。
- 旋转归一化：
使用普氏分析（Procrustes Analysis）等方法，将所有形状对齐到一个参考形状。这通常涉及旋转每个形状，使其与参考形状之间的差异最小化。

主成分分析（PCA）：

将所有归一化后的形状向量组成一个矩阵。
计算该矩阵的协方差矩阵。
对协方差矩阵进行特征值分解，得到特征值和特征向量。
选择前几个最大的特征值对应的特征向量，这些特征向量代表了形状的主要变化模式。

利用数据集中的标注的人脸数据进行建模
线性模型构建：

- 平均形状：
计算所有归一化形状的平均值，得到平均形状向量mean_shape。
- 形状参数：
对于一个新的形状，可以通过将它投影到PCA得到的特征向量上，得到一组形状参数b_s。
- 形状模型：
可以使用以下线性模型来表示任何形状：
shape = mean_shape + P_s * b_s
(x = mean_x + p_s*b_s)
其中，P_s是PCA得到的特征向量矩阵，b_s是形状参数向量（即表示该向量在数据集构成的形状空间的中的坐标表示）。

### 人脸局部纹理特征提取

局部纹理提取：

- 定义局部区域：
对于每个特征点，在其周围定义一个固定大小的矩形区域，作为该特征点的局部纹理。例如，可以在每个特征点周围定义一个32x32像素的矩形区域。
- 提取像素值：
提取每个局部区域内的像素值，并将这些像素值按顺序排列成一个向量。例如，对于第一个特征点，其局部纹理向量可以表示为：
g1 = [像素1, 像素2, ..., 像素1024]
将所有特征点的局部纹理向量连接成一个更长的向量。

纹理归一化：

- 均值归一化：
计算局部纹理向量中所有像素值的平均值，然后将每个像素值减去该平均值。
- 方差归一化：
计算局部纹理向量中所有像素值的标准差，然后将每个像素值除以该标准差。
通过这样的归一化，使得纹理的均值为0，方差为1，可以减少光照变化对纹理的影响。

主成分分析：

线性模型构建：
(g = mean_g + p_g*b_g)  // 一个特征点纹理的向量表示

### 联合特征表示

- 联合向量：
将归一化后的形状参数向量（b_s）和纹理参数向量（b_g）连接成一个联合向量b。
为了平衡形状和纹理的重要性，可以为形状参数向量添加一个权重W_s。
b = [W_s * b_s, b_g]
- 联合模型：
使用主成分分析（PCA）对联合向量[p_s, p_g]进行分析，得到一组正交的联合变化模式矩阵P_c。
使用以下线性模型来表示联合特征：
b = P_c * c
其中，c是联合参数向量，它表示形状和纹理的联合变化。
比如改变c向量的前两个值可以改变定位到的眼睛或者鼻子（嘴巴）的形状大小等变化

## 形状约束局部模型搜索

对于一张陌生的图片，人为给定一组初始特征点
用向量 x = (x1,x2,x3,...,y1,y2,y3,...)T 表示
它用来初始化形状参数b_s，以及纹理参数b_g

x = T_t(mean_x + p_s*b_s); // 形状向量，T_t是一个相似变换，用于将形状模型的坐标变换到图像坐标
那么 参数表示为 p = [tT | b_sT]T

这里 x 表示形状向量，T_t表示变换矩阵是未知的，b_s表示初始特征向量在数据集构成的形状空间的坐标表示，也是未知的（需要计算），而mean_x 表示数据集的平均坐标和p_s是数据集的主成分分析后得到的特征空间都是已知的。

所以我们需要的陌生的图片的特征点向量 X 就是关于 未知参数 p 的一个函数，可以计算。

响应图的计算依赖纹理模型
我们已经初始化了一个纹理模型，接下来会计算纹理模型与陌生图片的相似度，然后更新纹理参数b_g，以便模型更好地拟合陌生图片
根据给定的初始特征点，可以初始化参数b_g，从而初始化纹理模型（即是一个像素排列矩阵），接着在图像中选取一块相同大小的区域进行像素排列得到一个纹理向量，然后计算这两者的相似度
以当前特征点位置为中心，定义一个局部区域。在局部区域内滑动生成的模板，计算每个位置的相似性度量值（如归一化相关性）

计算相应图
对于一个初始特征点，使用纹理模板生成一个新的特征点坐标，然后在图像的一个局域区内（被约束在形状模型和纹理模型的范围内，每一层迭代都会随着更新的特征点进行更新）进行匹配

我们最终的目的是得到一个最贴近目标的特征点位置，也就是说我们要得到一个最优的b_g和b_s，所以设计以下函数来迭代优化得到最优的b_g b_s

设关于p的函数表示为 f(p) = sum(I_i(x_i,y_i)) + k*sum(-b_j^2 / λ_j)

I_i(x_i,y_i)表示第i个特征点区域的响应图
第二项是形状给定形状参数b_s和特征值λ的对数似然估计（正则化）
k是权重（根据数据集计算f(p)来进行初始化）

显然f(p)越大，表示由当前的b_g和s_g计算得到的特征点越接近真实值
优化算法：Nelder-Mead单纯形算法（用于寻找局部最值）

